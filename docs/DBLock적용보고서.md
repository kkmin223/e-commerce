# 동시성 문제 해결을 위한 DB LOCK 적용 보고서

## 1. DB Lock의 개념 및 필요성

동시성 문제란 여러 사용자가 동시에 동일한 데이터에 접근하거나 갱신할 때 데이터의 일관성이 깨지는 현상을 의미합니다. 이를 해결하기 위해 DB에서는 Lock(락)을 활용하여 데이터의 무결성과 일관성을 보장합니다.

- **낙관적 락(Optimistic Lock):**  
  데이터에 락을 걸지 않고, 트랜잭션 커밋 시점에 데이터가 변경되지 않았는지(버전 등으로) 검증하여 충돌 시 롤백하는 방식입니다.
- **비관적 락(Pessimistic Lock):**  
  데이터를 읽거나 수정할 때 즉시 DB에 락을 걸어, 다른 트랜잭션의 접근을 차단하는 방식입니다.

---

## 2. 락 적용 기준 및 전략

- **낙관적 락:**  
  충돌 가능성이 낮고, 충돌 시 재시도가 용이한 업무에 적용  
  (예: 한 유저의 잔액 충전 등)
- **비관적 락:**  
  충돌 가능성이 높고, 데이터 무결성이 매우 중요한 업무에 적용  
  (예: 쿠폰 선착순 발급, 재고 차감, 동시 쿠폰 사용, 잔액 사용 등)

---

## 3. 잔액 관련 기능의 락 전략 변경 및 이유

### 기존 전략

- **잔액 충전:** 낙관적 락 적용
- **잔액 사용:** 비관적 락 적용

### 문제점

잔액 충전과 잔액 사용이 **동일한 데이터(잔액 필드)에 대해 서로 다른 락 전략**을 사용하면  
아래와 같은 문제가 발생할 수 있습니다.

- 한 트랜잭션에서는 낙관적 락(충전),  
  다른 트랜잭션에서는 비관적 락(사용)을 사용하는 경우  
  **락 간섭이 제대로 발생하지 않아 동시성 버그**가 발생할 수 있습니다.
- 예를 들어, 한쪽에서 비관적 락으로 잔액을 점유하고 있는데  
  다른 쪽에서 낙관적 락으로 접근하면  
  데이터 불일치, 중복 갱신, 오염 등의 문제가 발생할 수 있습니다.

### 개선 방향

**잔액 충전 기능도 비관적 락으로 일원화**하여  
잔액 관련 모든 트랜잭션이 동일한 락 전략을 사용하도록 변경합니다.

- **적용 방법:**
  - 잔액 충전 시에도 비관적 락(`@Lock(LockModeType.PESSIMISTIC_WRITE)`) 적용
  - 잔액 사용과 동일하게 트랜잭션 내에서 락을 획득한 뒤 잔액을 변경
- **기대 효과:**
  - 잔액 데이터에 대한 동시성 문제가 완전히 해소됨
  - 모든 잔액 관련 트랜잭션이 일관된 방식으로 동작하여 예측 가능성 및 안정성 향상

---

## 4. 기능별 락 적용 내역

### 1) 잔액 충전/사용 기능

- **적용 배경:**  
  여러 트랜잭션이 동시에 잔액을 충전하거나 사용할 수 있으므로  
  충돌 가능성이 높음
- **적용 방법:**
  - 잔액 충전 및 사용 모두 비관적 락(`@Lock(LockModeType.PESSIMISTIC_WRITE)`) 적용
  - 트랜잭션 내에서 잔액 변경 처리
  - 데이터 무결성 보장, 충돌 완전 차단

### 2) 쿠폰 선착순 발급

- **적용 배경:**  
  다수의 유저가 동시에 쿠폰을 요청하는 상황이 빈번하여 충돌 가능성이 매우 높음
- **적용 방법:**
  - 쿠폰 조회 시 비관적 락 적용
  - 트랜잭션 내에서 쿠폰 수량 차감 및 발급 처리

### 3) 상품 재고 차감

- **적용 배경:**  
  결제 시 다수의 유저가 동시에 재고를 차감하는 경우가 많음
- **적용 방법:**
  - 상품 조회 시 비관적 락 적용
  - 트랜잭션 내에서 재고 차감 및 결제 처리

### 4) 동시 쿠폰 사용

- **적용 배경:**  
  여러 사용자가 같은 쿠폰을 동시에 사용할 수 있어 충돌 가능성이 높음
- **적용 방법:**
  - 쿠폰 사용 시 비관적 락 적용
  - 트랜잭션 내에서 쿠폰 사용 처리 및 상태 변경

---

## 5. 적용 효과
- **효과:**
  - 데이터 무결성 보장
  - 중복 발급/차감/사용 등 비즈니스 오류 방지
  - 사용자 신뢰도 및 서비스 품질 향상

---

## 6. 장단점 및 향후 개선 방향

### 1) 장점

- 충돌이 많은 환경에서 데이터 무결성을 확실하게 보장
- 모든 잔액 관련 트랜잭션이 일관된 방식으로 동작하여 예측 가능성 및 안정성 향상

### 2) 단점

- 락 대기, 데드락, 성능 저하, 확장성 한계 등 부작용 발생 가능

### 3) 향후 개선 방향

- 트래픽 증가 시 락 분산(샤딩, CQRS 등) 또는 비동기 처리, 이벤트 기반 아키텍처 도입 가능
- 락 경합이 심한 영역에 대해 Redis 분산락, 메시지 큐 등 대안 기술 도입 가능

---

## 7. 결론

시스템의 동시성 문제를 해결하기 위해  
업무 특성에 맞는 락 전략을 적용하고,  
특히 **잔액 충전/사용에 대해 비관적 락을 일원화**함으로써  
데이터 무결성과 비즈니스 신뢰성을 확보할 수 있었습니다.  
향후에도 트래픽 변화와 서비스 요구사항에 따라  
동시성 처리 전략을 지속적으로 개선할 예정입니다.
