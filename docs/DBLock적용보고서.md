# 동시성 문제 해결을 위한 DB LOCK 적용 보고서

## 1. DB Lock의 개념 및 필요성
동시성 문제란 여러 사용자가 동시에 동일한 데이터에 접근하거나 갱신할 때 데이터의 일관성이 깨지는 현상을 의미합니다. 이를 해결하기 위해 DB에서는 Lock(락)을 활용하여 데이터의 무결성과 일관성을 보장합니다. 
- 낙관적 락(Optimistic Lock):
데이터에 락을 걸지 않고, 트랜잭션 커밋 시점에 데이터가 변경되지 않았는지(버전 등으로) 검증하여 충돌 시 롤백하는 방식입니다.
- 비관적 락(Pessimistic Lock):
데이터를 읽거나 수정할 때 즉시 DB에 락을 걸어, 다른 트랜잭션의 접근을 차단하는 방식입니다.

## 2. 락 적용 기준 및 전략
- 낙관적 락:
충돌 가능성이 낮고, 충돌 시 재시도가 용이한 업무에 적용
(예: 한 유저의 잔액 충전 등)
- 비관적 락:
충돌 가능성이 높고, 데이터 무결성이 매우 중요한 업무에 적용
(예: 쿠폰 선착순 발급, 재고 차감, 동시 쿠폰 사용, 잔액 사용 등)

## 3. 낙관적 락 적용 기능
### 1) 잔액 충전 기능
- 적용 배경:
한 명의 유저가 동시에 여러 번 충전하는 경우는 드물어 충돌 가능성이 낮음
- 적용 방법:
- User 엔티티에 `@Version` 필드 추가
- 유저 조회 시 `@Lock(LockModeType.OPTIMISTIC)` 또는 `@Version` 활용
- 충돌(버전 불일치) 시 `OptimisticLockException` 발생 → 재시도 로직 구현
- 재시도 최대 횟수 초과 시 예외 처리 및 사용자 알림

## 4. 비관적 락 적용 기능

### 1) 쿠폰 선착순 발급
- 적용 배경:
다수의 유저가 동시에 쿠폰을 요청하는 상황이 빈번하여 충돌 가능성이 매우 높음
- 적용 방법:
  - 쿠폰 조회 시 `@Lock(LockModeType.PESSIMISTIC_WRITE)` 적용
  - 트랜잭션 내에서 쿠폰 수량 차감 및 발급 처리
  - 동시성 완벽 제어, 초과 요청은 예외 처리

### 2) 상품 재고 차감
- 적용 배경:
결제 시 다수의 유저가 동시에 재고를 차감하는 경우가 많음
- 적용 방법:
  - 상품 조회 시 `@Lock(LockModeType.PESSIMISTIC_WRITE)` 적용
  - 트랜잭션 내에서 재고 차감 및 결제 처리
  - 데이터 무결성 보장, 재고 부족 시 예외 처리

### 3) 동시 쿠폰 사용
- 적용 배경:
여러 사용자가 같은 쿠폰을 동시에 사용할 수 있어 충돌 가능성이 높음
- 적용 방법:
  - 쿠폰 사용 시 `@Lock(LockModeType.PESSIMISTIC_WRITE)` 적용
  - 트랜잭션 내에서 쿠폰 사용 처리 및 상태 변경

### 4) 잔액 사용
- 적용 배경:
여러 사용자가 동시에 잔액을 사용할 때 충돌 가능성이 높음
- 적용 방법:
  - 잔액 차감 시 `@Lock(LockModeType.PESSIMISTIC_WRITE)` 적용
  - 트랜잭션 내에서 잔액 차감 및 결제 처리
